<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nes.css/2.0.0/css/nes.min.css"
        integrity="sha512-yLfn7V0hubHgkT9/iqdUZI5uyhxIXobm6WynYpG0zRdUnDzH2DkaajPJ05CLjHVCX7RjX4UFw6ypW7sXPIr97Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            width: 90%;
            background-color: #333;
        }

        canvas {
            border: 1px dashed green;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="800" height="400"></canvas>
    <br>
    <input type="color" id="pColor" value="#0000FF">
    <input type="number" min="1" max="50" step="1" id="pSize" value="5" class="nes-input"> 
    <button onclick="clearCanvas()" class="nes-btn is-warning">清空重置</button> -
    <button onclick="saveCanvas()" class="nes-btn is-primary">儲存</button>
    <script>
        let count = 0;
        // {"x1":0,"y1":0,"x2":0,"y2":0,"c":"#","s":5}
        const socket = new WebSocket(`ws://${location.host}`);

        socket.addEventListener('message', function (event) {
            let dataObj;
            try {
                dataObj = JSON.parse(event.data);
                ctx.beginPath();
                ctx.strokeStyle = dataObj.c;
                ctx.lineWidth = dataObj.s;
                ctx.moveTo(dataObj.x1, dataObj.y1);
                ctx.lineTo(dataObj.x2, dataObj.y2);
                ctx.stroke();
            } catch (ex) {

            }
        });

        const startP = {
            x: 0, y: 0
        };

        const myCanvas = document.querySelector('#myCanvas'),
            pColor = document.querySelector('#pColor'),
            pSize = document.querySelector('#pSize'),
            ctx = myCanvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        const mDown = event => {
            window.addEventListener('mouseup', mUp);
            myCanvas.addEventListener('mousemove', mMove);
            // ctx.beginPath();
            // ctx.moveTo(event.offsetX, event.offsetY);
            startP.x = event.offsetX;
            startP.y = event.offsetY;
        };
        const mUp = event => {
            window.removeEventListener('mouseup', mUp);
            myCanvas.removeEventListener('mousemove', mMove);
        };
        const mMove = event => {
            // ctx.lineTo(event.offsetX, event.offsetY);
            // ctx.stroke();
            const sendObj = {
                x1: startP.x,
                y1: startP.y,
                c: pColor.value,
                s: pSize.value,
                x2: event.offsetX,
                y2: event.offsetY,
            };
            console.log(++count, sendObj);
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(sendObj));
            }
            startP.x = event.offsetX;
            startP.y = event.offsetY;
        };
        myCanvas.addEventListener('mousedown', mDown);

        // 設置畫筆大小顏色
        const setPen = () => {
            ctx.strokeStyle = pColor.value;
            ctx.lineWidth = pSize.value;
        };
        pColor.addEventListener('change', setPen);
        pSize.addEventListener('change', setPen);
        setPen();

        const clearCanvas = () => {
            ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        };


    </script>
</body>

</html>